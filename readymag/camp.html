<div id="rmSeasonTabs" class="rm-season-tabs"></div>
<div class="rm-season-title-wrapper">
  <h2 id="rmSeasonTitle" class="rm-season-title"></h2>
  <span id="rmSeasonYear" class="rm-season-year"></span>
</div>
<div id="camps-grid" class="rm-camps-grid"></div>

<!-- ГЛОБАЛЬНАЯ МОДАЛКА ДЛЯ ВВОДА РЕБЁНКА -->
<div class="rm-modal" id="campModal">
  <div class="rm-modal__backdrop" id="campModalBackdrop" data-modal-close></div>
  <div class="rm-modal__dialog">
    <div class="rm-modal__head">
      <h3 class="rm-modal__title" id="campModalTitle">Camp</h3>
      <button class="rm-modal__close" type="button" data-modal-close>✕</button>
    </div>
    <div class="rm-modal__body">
      <div class="rm-modal__field">
        <label for="campSlotSelect">Termin</label>
        <select id="campSlotSelect" class="rm-select"></select>
      </div>
      <div class="rm-modal__row">
        <div class="rm-modal__field">
          <label for="campChildFirst">Vorname</label>
          <input id="campChildFirst" class="rm-input" type="text" />
        </div>
        <div class="rm-modal__field">
          <label for="campChildLast">Nachname</label>
          <input id="campChildLast" class="rm-input" type="text" />
        </div>
      </div>
      <div class="rm-modal__note" id="campModalNote"></div>
    </div>
    <div class="rm-modal__foot">
      <button class="rm-btn rm-pay" id="campModalAdd">Zum Warenkorb</button>
    </div>
  </div>
</div>

<style>
  /* контейнер всего списка */
  .rm-camps-grid {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
  }

  /* заголовок группы (категории) + тонкая линия */
  .rm-group {
    width: 100%;
    display: grid;
    grid-template-columns: 160px minmax(0, 1fr); /* фикс слева, гибко справа */
    column-gap: 40px;
    border-top: 0.5px solid rgba(0, 0, 0, 1);
    padding-top: 14px;
  }

  .rm-group-header {
    font-size: 12px;
    margin-bottom: 4px;
  }

  .rm-camp-row-container {
    display: flex;
    flex-direction: column;
  }

  .rm-group-label {
    white-space: nowrap;
  }

  .rm-camp-row {
    position: relative;
    display: grid;
    grid-template-columns:
      minmax(0, 3fr) /* Titel */
      minmax(0, 1.6fr) /* Zeitraum (Wochen) */
      minmax(0, 1.4fr) /* Zeit (Uhrzeiten) */
      minmax(0, 1fr) /* Preis */
      auto; /* Button */
    align-items: start;
    column-gap: 40px;
    padding-bottom: 40px;
  }
  .rm-camp-row:not(:last-child) {
    border-bottom: 0.5px solid rgba(0, 0, 0, 1);
  }
  .rm-camp-row:not(:first-child) {
    padding-top: 14px;
  }

  @media (max-width: 900px) {
    .rm-camp-row {
      grid-template-columns: 1fr;
      row-gap: 6px;
      padding: 16px 0;
    }
  }

  .rm-col-title {
    font-size: 16px;
    font-weight: 700;
  }
  .rm-col-title a.rm-course-link {
    color: inherit;
    text-decoration: none;
  }
  .rm-col-title a.rm-course-link:hover {
    text-decoration: underline;
  }

  .rm-col-date,
  .rm-col-time {
    font-size: 12px;
    line-height: 1.4;
  }

  .rm-col-price {
    font-size: 12px;
    font-weight: 700;
  }

  .rm-col-terms {
    font-size: 12px;
    line-height: 1.4;
  }

  .rm-col-price {
    font-size: 12px;
    font-weight: 700;
  }

  .rm-col-btn {
    text-align: right;
  }
  @media (max-width: 900px) {
    .rm-col-btn {
      text-align: left;
      margin-top: 6px;
    }
  }

  .rm-btn {
    background: #fff;
    color: #000;
    padding: 4px 14px;
    cursor: pointer;
    border: 0;
    border-radius: 999px;
    font-size: 12px;
  }
  .rm-btn:hover {
    background: #000;
    color: #fff;
  }
  .rm-btn[disabled] {
    opacity: 0.4;
    cursor: not-allowed;
  }
  .rm-btn-big {
    padding: 10px;
  }

  /* ======== МОДАЛЬНОЕ ОКНО ======== */
  .rm-modal {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }
  .rm-modal.open {
    display: flex;
  }

  .rm-modal__backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.35);
  }

  .rm-modal__dialog {
    position: relative;
    background: #fff;
    color: #000;
    padding: 38px 38px;
    box-sizing: border-box;
    max-width: 520px;
    width: 100%;
    z-index: 1;
    border-radius: 20px;
  }

  .rm-modal__head {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .rm-modal__title {
    font-size: 18px;
    font-weight: 700;
    margin: 0;
  }

  .rm-modal__close {
    border: 1px solid #000;
    background: #fff;
    border-radius: 999px;
    padding: 4px 8px;
    cursor: pointer;
  }

  .rm-modal__body {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 24px;
    border-radius: 20px;
  }

  .rm-modal__row {
    display: flex;
    gap: 10px;
  }
  @media (max-width: 600px) {
    .rm-modal__row {
      flex-direction: column;
    }
  }

  .rm-modal__field {
    flex: 1 1 0;
    display: flex;
    flex-direction: column;
    gap: 4px;
    font-size: 12px;
  }

  .rm-modal__field label {
    font-size: 12px;
    color: #555;
  }

  .rm-input,
  .rm-select {
    width: 100%;
    padding: 8px 10px;
    border: 1px solid #ccc;
    border-radius: 0;
    font-size: 14px;
    box-sizing: border-box;
  }
  .rm-input:focus,
  .rm-select:focus {
    outline: none;
    border-color: #000;
  }

  .rm-modal__note {
    font-size: 12px;
    color: #444;
  }

  .rm-modal__foot {
    display: flex;
    justify-content: flex-start;
    gap: 10px;
  }

  .rm-btn-secondary {
    padding: 8px 18px;
    border: 1px solid #000;
    background: #fff;
    color: #000;
    cursor: pointer;
    font-size: 14px;
    border-radius: 999px;
  }

  .rm-season-tabs {
    max-width: 1200px;
    margin: 0 auto 24px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .rm-season-tab {
    padding: 6px 14px;
    border-radius: 999px;
    border: 0;
    background: #fff;
    font-size: 12px;
    cursor: pointer;
  }

  .rm-season-tab.is-active {
    background: #000;
    color: #fff;
  }

  .rm-empty {
    max-width: 1200px;
    margin: 40px auto;
    padding: 24px 32px;
    border: 1px dashed rgba(0, 0, 0, 0.3);
    text-align: center;
    font-size: 14px;
    line-height: 1.5;
  }

  .rm-season-title-wrapper {
    position: relative;
    display: flex;
    align-items: start;
    justify-content: center;
    left: 10px;
    margin-bottom: 60px;
  }

  /* Заголовок сезона внутри виджета */
  .rm-season-title {
    max-width: 1200px;
    font-size: 34px;
    line-height: 1.1;
    font-weight: 500;
    text-align: center;
  }

  .rm-season-year {
    position: relative;
    top: 7px;
    font-size: 10px;
    font-weight: 400;
  }

  /* Табы – уже есть, добавим ховер по цветам сезона */
  .rm-season-tab:hover {
    background: var(--rm-season-tab-hover-bg);
    color: var(--rm-season-tab-hover-text);
  }

  /* Обёртка списка + градиент */
  .rm-list-wrapper {
    position: relative;
    max-width: 1200px;
    margin: 0 auto;
    max-height: 650px; /* чтобы влезало около 8 кэмпов */
    overflow: hidden;
  }

  .rm-list-inner {
    background: var(--rm-season-bg);
  }

  .rm-list-fade {
    position: absolute;
    left: 0;
    right: 0;
    bottom: 0;
    height: 180px;
    pointer-events: none;
  }

  /* Кнопка "Все кэмпы" */
  .rm-all-link-wrap {
    max-width: 1200px;
    margin: 24px auto 0;
    text-align: center;
  }

  .rm-all-link {
    display: inline-block;
    padding: 10px 24px;
    border-radius: 999px;
    background: #000;
    color: #fff;
    font-size: 14px;
    text-decoration: none;
  }
  .rm-all-link:hover {
    background: #fff;
    color: #000;
  }

  /* Плейсхолдер для пустого сезона (с картинкой и текстом) */
  .rm-empty-season {
    border-top: 0.5px solid rgba(0, 0, 0, 1);
    max-width: 1200px;
    padding: 24px 32px;
    background: var(--rm-season-bg);

    /* Два ребенка равной ширины */
    display: flex;
    gap: 32px;
    align-items: start; /* Чтобы дети были одинаковой высоты */
  }

  /* Первый ребенок - flex контейнер для своих двух детей */
  .rm-empty-season > *:first-child,
  .rm-empty-season > *:nth-child(2) {
    flex: 0 0 25%;
  }

  @media (max-width: 900px) {
    .rm-empty-season {
      flex-direction: column;
      gap: 24px;
    }
  }
  .rm-empty-season__image {
    max-width: 360px; /* регулируй размер */
    width: 100%;
    margin: 0 auto; /* центрирует в колонке */
  }

  .rm-empty-season__image img {
    width: 100%;
    height: auto;
    display: block;
    border-radius: 16px; /* смягчает края как в макете */
  }

  .rm-empty-season__meta {
    font-size: 14px;
    line-height: 1.5;
  }
  .rm-empty-season__dates {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 8px;
  }
  .rm-empty-season__text {
    margin-bottom: 8px;
  }
</style>

<script>
  // ===== shared CartStore / CartBus (only once per page) =====
  (function () {
    if (window.CartStore) return;

    var Bus = new EventTarget();

    var Store = {
      items: [],
      email: '',
      listeners: [],
      subscribe: function (fn) {
        this.listeners.push(fn);
        fn(this);
      },
      notify: function () {
        var self = this;
        this.listeners.forEach(function (fn) {
          fn(self);
        });
      },
      add: function (item) {
        this.items.push(item);
        this.persist();
        this.notify();
      },
      remove: function (index) {
        this.items.splice(index, 1);
        this.persist();
        this.notify();
      },
      clear: function () {
        this.items = [];
        this.persist();
        this.notify();
      },
      setEmail: function (v) {
        this.email = v;
        this.persist();
        this.notify();
      },
      totalCents: function () {
        return this.items.reduce(function (sum, it, i) {
          var factor = i > 0 ? 0.9 : 1;
          return sum + Math.round(it.amount * factor);
        }, 0);
      },
      persist: function () {
        try {
          localStorage.setItem(
            'camp_cart_v1',
            JSON.stringify({
              items: this.items,
              email: this.email,
            })
          );
        } catch (e) {}
      },
    };

    try {
      var saved = JSON.parse(localStorage.getItem('camp_cart_v1') || 'null');
      if (saved && Array.isArray(saved.items)) {
        Store.items = saved.items;
        Store.email = saved.email || '';
      }
    } catch (e) {}

    window.CartStore = Store;
    window.CartBus = Bus;
  })();

  // ===== Product list + Modal =====
  (function () {
    var API_BASE = 'https://clavis-readymag-stripe.vercel.app';

    var grid = document.getElementById('camps-grid');
    if (!grid) return;

    var seasonTabs = document.getElementById('rmSeasonTabs');

    var YEAR = '2026';
    // какой сезон показывать по умолчанию (на главной можно просто один оставить)
    var DEFAULT_SEASON = `winter_${YEAR}`;

    var MAX_CAMPS = 8;

    // включены ли табы сезонов (на overview-странице) —
    // на детальных страницах курса можно выключить
    var ENABLE_SEASON_TABS = false;
    // все кэмпы с бэка
    var ALL_CATALOG = [];
    // текущий выбранный сезон
    var ACTIVE_SEASON = null;

    // Если страница-обзор — оставь null.
    // Если это страница конкретного курса — поставь ключ readymag_page из Stripe.
    var RM_PAGE_KEY = 'manga_storytelling'; // для overview
    // var RM_PAGE_KEY = 'fashion_design'; // для страницы Fashion Design

    // конфиг сезонов, которые хотим показывать
    // можно добавить/удалить ключи по мере надобност
    var SEASONS_CONFIG = [
      {
        key: `winter_${YEAR}`,
        label: 'Winter',
        title: 'Winterferiencamps',
        bg: '#f9c7ff',
        tabHoverBg: '#000000',
        tabHoverText: '#f9c7ff',
        emptyImage:
          'https://i-p.rmcdn.net/691608e5a42add5705475928/5961069/image-5f626f2e-b2d9-41d9-b082-2283cd66f58a.png?e=webp&nll=true&cX=78&cY=3&cW=714&cH=809',
        emptyDates: '02.02 – 06.02',
        emptyText: `Unsere Winterferiencamps ${YEAR} sind bald hier buchbar.`,
      },
      {
        key: `spring_${YEAR}`,
        label: 'Frühling',
        title: 'Frühlingsferiencamps',
        bg: '#00A554',
        tabHoverBg: '#000000',
        tabHoverText: '#00A554',
        emptyImage:
          'https://i-p.rmcdn.net/691608e5a42add5705475928/5961069/image-0d1c61d7-a39a-48c2-9296-b37391c16673.png?e=webp&nll=true',
        emptyDates: '02.03 – 30.05',
        emptyText: `Hier erscheinen bald die Camps für die Frühlingsferien ${YEAR}.`,
      },
      {
        key: `summer_${YEAR}`,
        label: 'Sommer',
        title: 'Sommerferiencamps',
        bg: '#FFDB27',
        tabHoverBg: '#000000',
        tabHoverText: '#FFDB27',
        emptyImage:
          'https://i-p.rmcdn.net/691608e5a42add5705475928/5961069/image-7565f00b-9b0d-454f-ad93-90581d0d0521.png?e=webp&nll=true&cX=28.209119496855294&cY=0&cW=761.5817610062894&cH=1217',
        emptyDates: '01.06 – 13.08',
        emptyText:
          'In den Sommerferien verwandeln sich die Camps in Räume zum Ausprobieren und Gestalten.',
      },
      {
        key: `autumn_${YEAR}`,
        label: 'Herbst',
        title: 'Herbstferiencamps',
        bg: '#FF3B00',
        tabHoverBg: '#000000',
        tabHoverText: '#FF3B00',
        emptyImage:
          'https://i-p.rmcdn.net/691608e5a42add5705475928/5961069/image-422ec24e-5319-43fb-952c-8b77bf9a9575.png?e=webp&nll=true&cX=0&cY=1&cW=518&cH=828',
        emptyDates: '01.09 – 19.11',
        emptyText: `Bald finden Sie hier die Angebote für die Herbstferien ${YEAR}.`,
      },
    ];

    // элементы модалки
    var modal = document.getElementById('campModal');
    var modalTitle = document.getElementById('campModalTitle');
    var modalSelect = document.getElementById('campSlotSelect');
    var modalFirstName = document.getElementById('campChildFirst');
    var modalLastName = document.getElementById('campChildLast');
    var modalNote = document.getElementById('campModalNote');
    var modalAddBtn = document.getElementById('campModalAdd');

    var currentCourseKey = null;
    var courseIndex = {}; // courseKey -> { title, discipline, variants[] }

    function getSeasonConfig(key) {
      return (
        SEASONS_CONFIG.find(function (s) {
          return s.key === key;
        }) || null
      );
    }

    function formatEUR(cents) {
      var euro = (cents / 100).toFixed(2).replace('.', ',');
      return euro + '€';
    }

    function slotOrder(slot) {
      if (slot === 'morning') return 0;
      if (slot === 'afternoon') return 1;
      return 2;
    }

    function sortVariants(a, b) {
      // сначала по Zeitraum (строка), потом по слоту (morgen vor nachmittag)
      var pa = a.periodLabel || '';
      var pb = b.periodLabel || '';
      if (pa < pb) return -1;
      if (pa > pb) return 1;
      var sa = slotOrder(a.slot);
      var sb = slotOrder(b.slot);
      return sa - sb;
    }

    function getSeasonLabel(seasonKey) {
      if (!seasonKey) return '';
      var match =
        SEASONS_CONFIG.find(function (s) {
          return s.key === seasonKey;
        }) || null;
      if (match) return match.label;
      // fallback: winter_2026 -> "winter 2026"
      return String(seasonKey).replace(/_/g, ' ');
    }

    function getFilteredCatalogForSeason() {
      var catalog = ALL_CATALOG.slice();

      if (ACTIVE_SEASON) {
        catalog = catalog.filter(function (item) {
          return item.season === ACTIVE_SEASON;
        });
      }

      return catalog;
    }

    function renderCurrentSeason() {
      var catalog = getFilteredCatalogForSeason();
      var conf = getSeasonConfig(ACTIVE_SEASON) || {};

      if (!catalog || !catalog.length) {
        // пустой сезон → показываем картинку и текст из конфига
        applySeasonStyles(ACTIVE_SEASON);

        grid.innerHTML =
          '<div class="rm-empty-season">' +
          (conf.emptyDates
            ? '<div class="rm-empty-season__dates">' +
              conf.emptyDates +
              '</div>'
            : '') +
          '<div class="rm-empty-season__image">' +
          (conf.emptyImage
            ? '<img src="' +
              conf.emptyImage +
              '" alt="' +
              (conf.title || '') +
              '">'
            : '') +
          '</div>' +
          (conf.emptyText
            ? '<div class="rm-empty-season__text">' + conf.emptyText + '</div>'
            : '') +
          '</div>';
        return;
      }

      // есть кэмпы
      applySeasonStyles(ACTIVE_SEASON);
      renderGrid(catalog);
    }

    function initSeasonTabs() {
      if (!seasonTabs || !ENABLE_SEASON_TABS) return;

      // показываем все сезоны из конфига, даже если по ним ещё нет кэмпов
      var tabs = SEASONS_CONFIG.slice();

      if (!tabs.length) {
        seasonTabs.style.display = 'none';
        return;
      }

      // выбираем активный сезон:
      // 1) DEFAULT_SEASON, если он есть в конфиге
      // 2) иначе — первый из списка
      if (!ACTIVE_SEASON) {
        var hasDefault = tabs.some(function (s) {
          return s.key === DEFAULT_SEASON;
        });

        ACTIVE_SEASON = hasDefault ? DEFAULT_SEASON : tabs[0].key;
      }

      seasonTabs.innerHTML = tabs
        .map(function (s) {
          return (
            '<button class="rm-season-tab" data-season="' +
            s.key +
            '">' +
            s.label +
            '</button>'
          );
        })
        .join('');

      function updateTabUI() {
        seasonTabs.querySelectorAll('[data-season]').forEach(function (btn) {
          var k = btn.getAttribute('data-season');
          if (k === ACTIVE_SEASON) btn.classList.add('is-active');
          else btn.classList.remove('is-active');
        });
      }

      seasonTabs.querySelectorAll('[data-season]').forEach(function (btn) {
        btn.addEventListener('click', function () {
          ACTIVE_SEASON = btn.getAttribute('data-season');
          applySeasonStyles(ACTIVE_SEASON);
          updateTabUI();
          renderCurrentSeason();
        });
      });

      applySeasonStyles(ACTIVE_SEASON);
      updateTabUI();
    }

    var seasonTitleEl = document.getElementById('rmSeasonTitle');
    var seasonYearEl = document.getElementById('rmSeasonYear');

    function applySeasonStyles(seasonKey) {
      var conf = getSeasonConfig(seasonKey) || {};

      var bg = conf.bg || 'var(--rm-season-bg)';
      var tabHoverBg = conf.tabHoverBg || '#000000';
      var tabHoverText = conf.tabHoverText || '#ffffff';

      document.documentElement.style.setProperty('--rm-season-bg', bg);
      document.documentElement.style.setProperty(
        '--rm-season-tab-hover-bg',
        tabHoverBg
      );
      document.documentElement.style.setProperty(
        '--rm-season-tab-hover-text',
        tabHoverText
      );

      // инициализируем табы сезонов (на overview)
      if (!RM_PAGE_KEY && ENABLE_SEASON_TABS) {
        if (seasonTitleEl && conf.title) {
          seasonTitleEl.textContent = conf.title;
        }

        if (seasonYearEl) {
          seasonYearEl.textContent = YEAR;
        }
      }
    }

    // загрузка каталога
    fetch(API_BASE + '/api/catalog', { mode: 'cors' })
      .then(function (r) {
        return r.json();
      })
      .then(function (raw) {
        ALL_CATALOG = raw.catalog || [];

        // фильтр по конкретной Readymag-странице (как и раньше)
        if (RM_PAGE_KEY) {
          ALL_CATALOG = ALL_CATALOG.filter(function (item) {
            return item.readymagPage === RM_PAGE_KEY;
          });
        }

        // инициализируем табы сезонов (на overview)
        if (!RM_PAGE_KEY && ENABLE_SEASON_TABS) {
          initSeasonTabs();
        } else if (DEFAULT_SEASON) {
          // если табы отключены, но всё равно хотим показывать только один сезон
          ACTIVE_SEASON = DEFAULT_SEASON;
        }

        renderCurrentSeason();
        setupModalHandlers();
      })
      .catch(function (err) {
        console.error(err);
        grid.innerHTML = '<div>Fehler beim Laden des Katalogs</div>';
      });

    function parseStartMinutes(timeLabel) {
      if (!timeLabel) return null;
      var m = timeLabel.match(/(\d{2}):(\d{2})/); // ищем 09:30
      if (!m) return null;
      return parseInt(m[1], 10) * 60 + parseInt(m[2], 10);
    }

    function renderGrid(catalog) {
      courseIndex = {};

      var remaining = MAX_CAMPS;
      var shouldShowFade = catalog.length > MAX_CAMPS;

      // Группируем по возрасту
      var groups = {};
      var groupOrder = [];

      catalog.forEach(function (item) {
        var gKey = item.ageLabel || 'Jedes Alter';
        if (!groups[gKey]) {
          groups[gKey] = [];
          groupOrder.push(gKey);
        }
        groups[gKey].push(item);
      });

      var ageOrder = ['8-11 Jahre', '10+ Jahre', '12-16 Jahre'];

      groupOrder.sort(function (a, b) {
        var ia = ageOrder.indexOf(a);
        var ib = ageOrder.indexOf(b);

        if (ia === -1 && ib === -1) return a.localeCompare(b);
        if (ia === -1) return 1;
        if (ib === -1) return -1;
        return ia - ib;
      });

      var html = groupOrder
        .map(function (groupKey) {
          if (remaining <= 0) return '';

          var items = groups[groupKey];

          // внутри категории группируем по курсу (одноимённые)
          var courseMap = {}; // courseKey -> { title, variants[] }
          var courseOrder = [];

          items.forEach(function (it) {
            var cKey = (it.disciplineKey || '') + '|' + it.title;
            if (!courseMap[cKey]) {
              courseMap[cKey] = {
                title: it.title,
                readymagPage: it.readymagPage || '',
                variants: [],
              };
              courseOrder.push(cKey);
              courseIndex[cKey] = {
                title: it.title,
                discipline: groupKey,
                readymagPage: it.readymagPage || '',
                variants: courseMap[cKey].variants,
              };
            }
            courseMap[cKey].variants.push(it);
          });

          // сортируем курсы внутри age-группы
          courseOrder.sort(function (aKey, bKey) {
            var aVariants = (courseMap[aKey].variants || [])
              .slice()
              .sort(sortVariants);
            var bVariants = (courseMap[bKey].variants || [])
              .slice()
              .sort(sortVariants);

            var aFirst = aVariants[0] || {};
            var bFirst = bVariants[0] || {};

            var sa = slotOrder(aFirst.slot);
            var sb = slotOrder(bFirst.slot);
            if (sa !== sb) return sa - sb;

            var ta = parseStartMinutes(aFirst.timeLabel);
            var tb = parseStartMinutes(bFirst.timeLabel);
            if (ta != null && tb != null && ta !== tb) {
              return ta - tb;
            }

            return (courseMap[aKey].title || '').localeCompare(
              courseMap[bKey].title || ''
            );
          });

          // ограничиваем количество курсов в этой группе
          var limitedCourseOrder = courseOrder;
          if (limitedCourseOrder.length > remaining) {
            limitedCourseOrder = limitedCourseOrder.slice(0, remaining);
          }
          remaining -= limitedCourseOrder.length;

          if (!limitedCourseOrder.length) return '';

          // строим HTML только по limitedCourseOrder
          var rows = limitedCourseOrder
            .map(function (cKey) {
              var course = courseMap[cKey];
              var variants = course.variants.slice().sort(sortVariants);

              var href = '';
              if (course.readymagPage) {
                href =
                  'https://readymag.website/u612815371/5961069/' +
                  course.readymagPage +
                  '/';
              }

              var titleHtml = href
                ? '<a class="rm-course-link" href="' +
                  href +
                  '">' +
                  course.title +
                  '</a>'
                : course.title;

              // группируем по неделе (periodLabel)
              var byPeriod = {};
              var periodOrder = [];

              variants.forEach(function (v) {
                var key = v.periodLabel || '';
                if (!byPeriod[key]) {
                  byPeriod[key] = { label: v.periodLabel || '', times: [] };
                  periodOrder.push(key);
                }
                if (v.timeLabel) byPeriod[key].times.push(v.timeLabel);
              });

              var dateHtml = periodOrder
                .map(function (k) {
                  return byPeriod[k].label || '';
                })
                .join('<br>');

              var timeHtml = periodOrder
                .map(function (k) {
                  var g = byPeriod[k];
                  if (!g.times.length) return '';
                  return g.times.join('<br>');
                })
                .join('<br>');

              var amount = variants[0] ? variants[0].amount : 0;
              var freeSeats =
                variants[0] && typeof variants[0].freeSeats === 'number'
                  ? variants[0].freeSeats
                  : null;
              var isFull = freeSeats !== null && freeSeats <= 0;

              return (
                '<article class="rm-camp-row" data-course-key="' +
                cKey +
                '">' +
                '<div class="rm-col-title">' +
                titleHtml +
                '</div>' +
                '<div class="rm-col-date">' +
                dateHtml +
                '</div>' +
                '<div class="rm-col-time">' +
                timeHtml +
                '</div>' +
                '<div class="rm-col-price">' +
                formatEUR(amount || 0) +
                '</div>' +
                '<div class="rm-col-btn">' +
                '<button class="rm-btn rm-btn-big" data-open="' +
                cKey +
                '" ' +
                (isFull ? 'disabled' : '') +
                '>Jetzt buchen</button>' +
                '</div>' +
                '</article>'
              );
            })
            .join('');

          if (!rows) return '';

          return (
            '<section class="rm-group">' +
            '<div class="rm-group-header">' +
            '<span class="rm-group-label">' +
            groupKey +
            ':</span>' +
            '</div>' +
            '<div class="rm-camp-row-container">' +
            rows +
            '</div>' +
            '</section>'
          );
        })
        .join('');

      var conf = getSeasonConfig(ACTIVE_SEASON) || {};
      var gradientColor = conf.bg || 'var(--rm-season-bg)';

      grid.innerHTML = html;

      // обработчик открытия модалки
      grid.querySelectorAll('[data-open]').forEach(function (btn) {
        btn.addEventListener('click', function () {
          var key = btn.getAttribute('data-open');
          openModal(key);
        });
      });
    }

    function openModal(courseKey) {
      var course = courseIndex[courseKey];
      if (!course) return;
      currentCourseKey = courseKey;

      modalTitle.textContent = course.title || 'Camp';

      // наполняем select всеми вариантами (неделя+время)
      modalSelect.innerHTML = '';
      var variants = course.variants.slice().sort(sortVariants);

      variants.forEach(function (v) {
        var slotLabel =
          v.slot === 'morning'
            ? 'Vormittag'
            : v.slot === 'afternoon'
            ? 'Nachmittag'
            : '';
        var parts = [];
        if (v.periodLabel) parts.push(v.periodLabel);
        if (v.timeLabel) parts.push(v.timeLabel);
        if (slotLabel) parts.push('(' + slotLabel + ')');
        var text = parts.join(' · ');

        var opt = document.createElement('option');
        opt.value = v.id;
        opt.textContent = text || v.title || v.id;
        modalSelect.appendChild(opt);
      });

      modalFirstName.value = '';
      modalLastName.value = '';

      modalNote.textContent = variants.length
        ? 'Bitte wählen Sie den Termin und geben Sie den Namen des Kindes ein.'
        : '';

      modal.classList.add('open');
    }

    function closeModal() {
      modal.classList.remove('open');
      currentCourseKey = null;
    }

    function setupModalHandlers() {
      document.querySelectorAll('[data-modal-close]').forEach(function (btn) {
        btn.addEventListener('click', closeModal);
      });

      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') closeModal();
      });

      modalAddBtn.addEventListener('click', function () {
        if (!currentCourseKey) return;
        var course = courseIndex[currentCourseKey];
        if (!course) return;

        var fn = modalFirstName.value.trim();
        var ln = modalLastName.value.trim();
        if (!fn || !ln) {
          alert('Bitte Vorname und Nachname des Kindes eingeben.');
          return;
        }

        var selectedId = modalSelect.value;
        var variants = course.variants.slice().sort(sortVariants);
        var v =
          variants.find(function (x) {
            return x.id === selectedId;
          }) || variants[0];

        var slot = v.slot;

        window.CartStore.add({
          week: v.weekLabel || v.weekLabel,
          week_label: v.weekLabel || '',
          camp_type: v.disciplineLabelDe || v.disciplineKey || '',
          slot: slot,
          childFirst: fn,
          childLast: ln,
          basePriceEUR: (v.amount || 0) / 100,
          prices: {
            fullPriceId: v.fullPriceId,
            discPriceId: v.discPriceId,
          },

          campId: v.id,
          productId: v.productId,
          title: v.title,
          image: v.image,
          timeLabel: v.timeLabel,
          periodLabel: v.periodLabel,
          ageLabel: v.ageLabel,
          season: v.season,
          disciplineKey: v.disciplineKey,
          disciplineLabelDe: v.disciplineLabelDe,
          amount: v.amount,
          label: v.title + ' (' + (v.timeLabel || '') + ')',
        });

        closeModal();

        if (window.CartBus) {
          window.CartBus.dispatchEvent(new Event('cart:open'));
        }
      });
    }
  })();
</script>
