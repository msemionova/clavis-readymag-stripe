<div id="camps-grid" class="rm-camps-grid"></div>

<!-- ГЛОБАЛЬНАЯ МОДАЛКА ДЛЯ ВВОДА РЕБЁНКА -->
<div class="rm-modal" id="campModal">
  <div class="rm-modal__backdrop" id="campModalBackdrop" data-modal-close></div>
  <div class="rm-modal__dialog">
    <div class="rm-modal__head">
      <h3 class="rm-modal__title" id="campModalTitle">Camp</h3>
      <button class="rm-modal__close" type="button" data-modal-close>✕</button>
    </div>
    <div class="rm-modal__body">
      <div class="rm-modal__field">
        <label for="campSlotSelect">Termin</label>
        <select id="campSlotSelect" class="rm-select"></select>
      </div>
      <div class="rm-modal__row">
        <div class="rm-modal__field">
          <label for="campChildFirst">Vorname</label>
          <input id="campChildFirst" class="rm-input" type="text" />
        </div>
        <div class="rm-modal__field">
          <label for="campChildLast">Nachname</label>
          <input id="campChildLast" class="rm-input" type="text" />
        </div>
      </div>
      <div class="rm-modal__note" id="campModalNote"></div>
    </div>
    <div class="rm-modal__foot">
      <button class="rm-btn" id="campModalAdd">Zum Warenkorb</button>
      <button class="rm-btn-secondary" type="button" data-modal-close>
        Abbrechen
      </button>
    </div>
  </div>
</div>

<style>
  :root {
    --rm-gap: 32px;
    --rm-text: #000;
    --rm-btn-bg: #000;
    --rm-btn-text: #fff;
  }

  /* общий шрифт */
  * {
    font-family: 'Aeroport', -apple-system, system-ui, BlinkMacSystemFont,
      'Segoe UI', Ubuntu, 'Fira Sans', Roboto, 'Avenir Next', 'Helvetica Neue',
      Helvetica, Arial, sans-serif;
  }

  /* контейнер всего списка */
  .rm-camps-grid {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
  }

  /* заголовок группы (категории) + тонкая линия */
  .rm-group {
    width: 100%;
    display: flex;
    align-items: start;
    border-top: 0.5px solid rgba(0, 0, 0, 1);
    padding-top: 14px;
  }

  .rm-group-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 4px;
    font-size: 12px;
  }

  .rm-camp-row-container {
    display: flex;
    flex-direction: column;
  }

  .rm-group-label {
    min-width: 140px;
    white-space: nowrap;
  }

  .rm-group-line {
    flex: 1;
    height: 1px;
    background: #000;
    opacity: 0.25;
  }

  .rm-camp-row {
    position: relative;
    display: grid;
    grid-template-columns:
      minmax(0, 3fr) /* Titel */
      minmax(0, 1.6fr) /* Zeitraum (Wochen) */
      minmax(0, 1.4fr) /* Zeit (Uhrzeiten) */
      minmax(0, 1fr) /* Preis */
      auto; /* Button */
    align-items: start;
    column-gap: 40px;
    padding-bottom: 40px;
  }
  .rm-camp-row:not(:last-child) {
    border-bottom: 0.5px solid rgba(0, 0, 0, 1);
  }
  .rm-camp-row:not(:first-child) {
    padding-top: 14px;
  }

  @media (max-width: 900px) {
    .rm-camp-row {
      grid-template-columns: 1fr;
      row-gap: 6px;
      padding: 16px 0;
    }
  }

  .rm-col-title {
    font-size: 16px;
    font-weight: 700;
  }
  .rm-col-title a.rm-course-link {
    color: inherit;
    text-decoration: none;
  }
  .rm-col-title a.rm-course-link:hover {
    text-decoration: underline;
  }

  .rm-col-date,
  .rm-col-time {
    font-size: 12px;
    line-height: 1.4;
  }

  .rm-col-price {
    font-size: 12px;
    font-weight: 700;
  }

  .rm-col-terms {
    font-size: 12px;
    line-height: 1.4;
  }

  .rm-col-price {
    font-size: 12px;
    font-weight: 700;
  }

  .rm-col-btn {
    text-align: right;
  }
  @media (max-width: 900px) {
    .rm-col-btn {
      text-align: left;
      margin-top: 6px;
    }
  }

  .rm-btn {
    background: #fff;
    color: #000;
    padding: 4px 14px;
    cursor: pointer;
    border: 0;
    border-radius: 999px;
    font-size: 12px;
  }
  .rm-btn:hover {
    background: #000;
    color: #fff;
  }
  .rm-btn[disabled] {
    opacity: 0.4;
    cursor: not-allowed;
  }

  /* ======== МОДАЛЬНОЕ ОКНО ======== */
  .rm-modal {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }
  .rm-modal.open {
    display: flex;
  }

  .rm-modal__backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.35);
  }

  .rm-modal__dialog {
    position: relative;
    background: #fff;
    color: #000;
    border: 2px solid #000;
    padding: 20px 24px;
    box-sizing: border-box;
    max-width: 520px;
    width: 100%;
    z-index: 1;
    border-radius: 0;
  }

  .rm-modal__head {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .rm-modal__title {
    font-size: 18px;
    font-weight: 700;
    margin: 0;
  }

  .rm-modal__close {
    border: 1px solid #000;
    background: #fff;
    border-radius: 0;
    padding: 4px 8px;
    cursor: pointer;
  }

  .rm-modal__body {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 14px;
  }

  .rm-modal__row {
    display: flex;
    gap: 10px;
  }
  @media (max-width: 600px) {
    .rm-modal__row {
      flex-direction: column;
    }
  }

  .rm-modal__field {
    flex: 1 1 0;
    display: flex;
    flex-direction: column;
    gap: 4px;
    font-size: 12px;
  }

  .rm-modal__field label {
    font-size: 12px;
    color: #555;
  }

  .rm-input,
  .rm-select {
    width: 100%;
    padding: 8px 10px;
    border: 1px solid #ccc;
    border-radius: 0;
    font-size: 14px;
    box-sizing: border-box;
  }
  .rm-input:focus,
  .rm-select:focus {
    outline: none;
    border-color: #000;
  }

  .rm-modal__note {
    font-size: 12px;
    color: #444;
  }

  .rm-modal__foot {
    display: flex;
    justify-content: flex-start;
    gap: 10px;
  }

  .rm-btn-secondary {
    padding: 8px 18px;
    border: 1px solid #000;
    background: #fff;
    color: #000;
    cursor: pointer;
    font-size: 14px;
    border-radius: 0;
  }
</style>

<script>
  // ===== shared CartStore / CartBus (only once per page) =====
  (function () {
    if (window.CartStore) return;

    var Bus = new EventTarget();

    var Store = {
      items: [],
      email: '',
      listeners: [],
      subscribe: function (fn) {
        this.listeners.push(fn);
        fn(this);
      },
      notify: function () {
        var self = this;
        this.listeners.forEach(function (fn) {
          fn(self);
        });
      },
      add: function (item) {
        this.items.push(item);
        this.persist();
        this.notify();
      },
      remove: function (index) {
        this.items.splice(index, 1);
        this.persist();
        this.notify();
      },
      clear: function () {
        this.items = [];
        this.persist();
        this.notify();
      },
      setEmail: function (v) {
        this.email = v;
        this.persist();
        this.notify();
      },
      totalCents: function () {
        return this.items.reduce(function (sum, it, i) {
          var factor = i > 0 ? 0.9 : 1;
          return sum + Math.round(it.amount * factor);
        }, 0);
      },
      persist: function () {
        try {
          localStorage.setItem(
            'camp_cart_v1',
            JSON.stringify({
              items: this.items,
              email: this.email,
            })
          );
        } catch (e) {}
      },
    };

    try {
      var saved = JSON.parse(localStorage.getItem('camp_cart_v1') || 'null');
      if (saved && Array.isArray(saved.items)) {
        Store.items = saved.items;
        Store.email = saved.email || '';
      }
    } catch (e) {}

    window.CartStore = Store;
    window.CartBus = Bus;
  })();

  // ===== Product list + Modal =====
  (function () {
    var API_BASE = 'https://clavis-readymag-stripe.vercel.app';

    var grid = document.getElementById('camps-grid');
    if (!grid) return;

    // элементы модалки
    var modal = document.getElementById('campModal');
    var modalTitle = document.getElementById('campModalTitle');
    var modalSelect = document.getElementById('campSlotSelect');
    var modalFirstName = document.getElementById('campChildFirst');
    var modalLastName = document.getElementById('campChildLast');
    var modalNote = document.getElementById('campModalNote');
    var modalAddBtn = document.getElementById('campModalAdd');

    var currentCourseKey = null;
    var courseIndex = {}; // courseKey -> { title, discipline, variants[] }

    function formatEUR(cents) {
      var euro = (cents / 100).toFixed(2).replace('.', ',');
      return euro + '€';
    }

    function slotOrder(slot) {
      if (slot === 'morning') return 0;
      if (slot === 'afternoon') return 1;
      return 2;
    }

    function sortVariants(a, b) {
      // сначала по Zeitraum (строка), потом по слоту (morgen vor nachmittag)
      var pa = a.periodLabel || '';
      var pb = b.periodLabel || '';
      if (pa < pb) return -1;
      if (pa > pb) return 1;
      var sa = slotOrder(a.slot);
      var sb = slotOrder(b.slot);
      return sa - sb;
    }

    // Если страница-обзор — оставь null.
    // Если это страница конкретного курса — поставь ключ readymag_page из Stripe.
    var RM_PAGE_KEY = null; // для overview
    // var RM_PAGE_KEY = 'fashion_design'; // для страницы Fashion Design

    // загрузка каталога
    fetch(API_BASE + '/api/catalog', { mode: 'cors' })
      .then(function (r) {
        return r.json();
      })
      .then(function (raw) {
        var catalog = raw.catalog || [];

        if (RM_PAGE_KEY) {
          catalog = catalog.filter(function (item) {
            return item.readymagPage === RM_PAGE_KEY;
          });
        }

        renderGrid(catalog);
        setupModalHandlers();
      })
      .catch(function (err) {
        console.error(err);
        grid.innerHTML = '<div>Fehler beim Laden des Katalogs</div>';
      });

    function renderGrid(catalog) {
      courseIndex = {};

      // Группируем сначала по дисциплине (категория слева)
      var groups = {};
      var groupOrder = [];

      catalog.forEach(function (item) {
        var gKey = item.ageLabel || 'Jedes Alter';
        if (!groups[gKey]) {
          groups[gKey] = [];
          groupOrder.push(gKey);
        }
        groups[gKey].push(item);
      });

      var html = groupOrder
        .map(function (groupKey) {
          var items = groups[groupKey];

          // внутри категории группируем по курсу (одноимённые)
          var courseMap = {}; // courseKey -> { title, variants[] }
          var courseOrder = [];

          items.forEach(function (it) {
            var cKey = (it.disciplineKey || '') + '|' + it.title;
            if (!courseMap[cKey]) {
              courseMap[cKey] = {
                title: it.title,
                readymagPage: it.readymagPage || '',
                variants: [],
              };
              courseOrder.push(cKey);
              courseIndex[cKey] = {
                title: it.title,
                discipline: groupKey,
                readymagPage: it.readymagPage || '',
                variants: courseMap[cKey].variants,
              };
            }
            courseMap[cKey].variants.push(it);
          });

          var rows = courseOrder
            .map(function (cKey) {
              var course = courseMap[cKey];
              var variants = course.variants.slice().sort(sortVariants);

              var href = '';
              if (course.readymagPage) {
                // тут подставь базовый урл своего проекта в Readymag
                href =
                  'https://my.readymag.com/edit/5961069/preview/' +
                  course.readymagPage +
                  '/';
              }

              // далее, вместо прямого course.title:
              var titleHtml = href
                ? '<a class="rm-course-link" href="' +
                  href +
                  '">' +
                  course.title +
                  '</a>'
                : course.title;

              // группируем по неделе (periodLabel)
              var byPeriod = {};
              var periodOrder = [];

              variants.forEach(function (v) {
                var key = v.periodLabel || '';
                if (!byPeriod[key]) {
                  byPeriod[key] = { label: v.periodLabel || '', times: [] };
                  periodOrder.push(key);
                }
                if (v.timeLabel) byPeriod[key].times.push(v.timeLabel);
              });

              // колонка с неделями (каждая неделя один раз)
              var dateHtml = periodOrder
                .map(function (k) {
                  return byPeriod[k].label || '';
                })
                .join('<br>');

              // колонка со временем:
              // для каждой недели все её Zeiten построчно, группы недель тоже через <br>
              var timeHtml = periodOrder
                .map(function (k) {
                  var g = byPeriod[k];
                  if (!g.times.length) return '';
                  return g.times.join('<br>');
                })
                .join('<br>');

              var amount = variants[0] ? variants[0].amount : 0;

              var freeSeats =
                variants[0] && typeof variants[0].freeSeats === 'number'
                  ? variants[0].freeSeats
                  : null;
              var isFull = freeSeats !== null && freeSeats <= 0;

              return (
                '<article class="rm-camp-row" data-course-key="' +
                cKey +
                '">' +
                '<div class="rm-col-title">' +
                titleHtml +
                '</div>' +
                '<div class="rm-col-date">' +
                dateHtml +
                '</div>' +
                '<div class="rm-col-time">' +
                timeHtml +
                '</div>' +
                '<div class="rm-col-price">' +
                formatEUR(amount || 0) +
                '</div>' +
                '<div class="rm-col-btn">' +
                '<button class="rm-btn" data-open="' +
                cKey +
                '" ' +
                (isFull ? 'disabled' : '') +
                '>Jetzt buchen</button>' +
                '</div>' +
                '</article>'
              );
            })
            .join('');

          return (
            '<section class="rm-group">' +
            '<div class="rm-group-header">' +
            '<span class="rm-group-label">' +
            groupKey +
            ':</span>' +
            '</div>' +
            '<div class="rm-camp-row-container">' +
            rows +
            '</div>' +
            '</section>'
          );
        })
        .join('');

      grid.innerHTML = html;

      // обработчик открытия модалки
      grid.querySelectorAll('[data-open]').forEach(function (btn) {
        btn.addEventListener('click', function () {
          var key = btn.getAttribute('data-open');
          openModal(key);
        });
      });
    }

    function openModal(courseKey) {
      var course = courseIndex[courseKey];
      if (!course) return;
      currentCourseKey = courseKey;

      modalTitle.textContent = course.title || 'Camp';

      // наполняем select всеми вариантами (неделя+время)
      modalSelect.innerHTML = '';
      var variants = course.variants.slice().sort(sortVariants);

      variants.forEach(function (v) {
        var slotLabel =
          v.slot === 'morning'
            ? 'Vormittag'
            : v.slot === 'afternoon'
            ? 'Nachmittag'
            : '';
        var parts = [];
        if (v.periodLabel) parts.push(v.periodLabel);
        if (v.timeLabel) parts.push(v.timeLabel);
        if (slotLabel) parts.push('(' + slotLabel + ')');
        var text = parts.join(' · ');

        var opt = document.createElement('option');
        opt.value = v.id;
        opt.textContent = text || v.title || v.id;
        modalSelect.appendChild(opt);
      });

      modalFirstName.value = '';
      modalLastName.value = '';

      modalNote.textContent = variants.length
        ? 'Bitte wählen Sie den Termin und geben Sie den Namen des Kindes ein.'
        : '';

      modal.classList.add('open');
    }

    function closeModal() {
      modal.classList.remove('open');
      currentCourseKey = null;
    }

    function setupModalHandlers() {
      document.querySelectorAll('[data-modal-close]').forEach(function (btn) {
        btn.addEventListener('click', closeModal);
      });

      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') closeModal();
      });

      modalAddBtn.addEventListener('click', function () {
        if (!currentCourseKey) return;
        var course = courseIndex[currentCourseKey];
        if (!course) return;

        var fn = modalFirstName.value.trim();
        var ln = modalLastName.value.trim();
        if (!fn || !ln) {
          alert('Bitte Vorname und Nachname des Kindes eingeben.');
          return;
        }

        var selectedId = modalSelect.value;
        var variants = course.variants.slice().sort(sortVariants);
        var v =
          variants.find(function (x) {
            return x.id === selectedId;
          }) || variants[0];

        var slot = v.slot;

        window.CartStore.add({
          week: v.weekLabel || v.weekLabel,
          week_label: v.weekLabel || '',
          camp_type: v.disciplineLabelDe || v.disciplineKey || '',
          slot: slot,
          childFirst: fn,
          childLast: ln,
          basePriceEUR: (v.amount || 0) / 100,
          prices: {
            fullPriceId: v.fullPriceId,
            discPriceId: v.discPriceId,
          },

          campId: v.id,
          productId: v.productId,
          title: v.title,
          image: v.image,
          timeLabel: v.timeLabel,
          periodLabel: v.periodLabel,
          ageLabel: v.ageLabel,
          season: v.season,
          disciplineKey: v.disciplineKey,
          disciplineLabelDe: v.disciplineLabelDe,
          amount: v.amount,
          label: v.title + ' (' + (v.timeLabel || '') + ')',
        });

        closeModal();

        if (window.CartBus) {
          window.CartBus.dispatchEvent(new Event('cart:open'));
        }
      });
    }
  })();
</script>
