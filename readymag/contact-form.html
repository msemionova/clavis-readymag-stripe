<!-- ====== CONTACT BUTTON ====== -->
<p class="clavis-open-btn" id="clavisOpenBtn">KONTAKTE</p>

<!-- ====== OVERLAY + MODAL ====== -->
<div id="clavisOverlay" class="clavis-overlay" aria-hidden="true">
  <div
    class="clavis-modal"
    role="dialog"
    aria-modal="true"
    aria-labelledby="clavisTitle"
  >
    <button
      class="clavis-close"
      id="clavisCloseBtn"
      type="button"
      aria-label="Schließen"
    >
      ✕
    </button>

    <div class="clavis-layout">
      <div class="clavis-col clavis-col-title">
        <h2 class="clavis-title" id="clavisTitle">
          Du bist interessiert?<br />Senden uns eine Nachricht
        </h2>
      </div>

      <form id="clavisContactForm" class="clavis-form" novalidate>
        <label class="clavis-hp">
          Website
          <input name="website" autocomplete="off" />
        </label>

        <div class="clavis-grid">
          <div class="clavis-main">
            <div class="clavis-field">
              <label for="name">Vor- und Nachname</label>
              <input
                id="name"
                name="name"
                type="text"
                placeholder="Vor- und Nachname"
                required
                minlength="2"
                autocomplete="name"
              />
              <div class="err" data-err-for="name"></div>
            </div>

            <div class="clavis-field">
              <label for="childName">Name Ihres Kindes</label>
              <input
                id="childName"
                name="childName"
                type="text"
                placeholder="Name Ihres Kindes"
                required
                minlength="2"
                autocomplete="name"
              />
              <div class="err" data-err-for="childName"></div>
            </div>

            <div class="clavis-field">
              <label for="email">E-mail</label>
              <input
                id="email"
                name="email"
                type="email"
                placeholder="E-Mail-Adresse"
                required
                autocomplete="email"
              />
              <div class="err" data-err-for="email"></div>
            </div>

            <div class="clavis-field">
              <label for="phone">Telefonnummer</label>
              <input
                id="phone"
                name="phone"
                type="tel"
                placeholder="Telefonnummer"
                required
                inputmode="tel"
                autocomplete="tel"
                pattern="^[0-9+()\\s-]{6,}$"
              />
              <div class="err" data-err-for="phone"></div>
            </div>
          </div>

          <div class="clavis-side">
            <div class="clavis-message-block">
              <div class="clavis-message-title">
                Wie können wir Ihnen helfen?
              </div>
              <textarea
                id="message"
                name="message"
                rows="6"
                placeholder="Ihre Nachricht"
              ></textarea>
              <div class="err" data-err-for="message"></div>
            </div>

            <div class="clavis-checks">
              <label class="clavis-check">
                <input
                  class="clavis-checkbox"
                  id="privacy"
                  name="privacy"
                  type="checkbox"
                  required
                />
                <span>
                  Ich habe die
                  <a
                    href="https://readymag.website/u612815371/5961069/datenschutz"
                    target="_blank"
                    rel="noopener"
                    >Datenschutzerklärung</a
                  >
                  zur Kenntnis genommen
                </span>
              </label>
              <div class="err" data-err-for="privacy"></div>
            </div>
          </div>

          <button class="clavis-submit" type="submit">Nachricht senden</button>
          <div class="clavis-status" aria-live="polite"></div>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
  /* ===== Button ===== */
  .clavis-open-btn {
    position: relative;
    top: 14px;
    color: #000;
    font-weight: 500;
    font-size: 10px;
    cursor: pointer;
    z-index: 1000; /* must stay tappable above RM layers */
  }

  /* ===== Overlay (IMPORTANT: closed state must NOT block scroll) ===== */
  .clavis-overlay {
    position: fixed;
    inset: 0;
    z-index: 2147483647;
    background: rgba(0, 0, 0, 0.65);

    display: none; /* KEY: not in layout when closed */
    pointer-events: none; /* KEY */

    box-sizing: border-box;
  }

  /* Open state */
  .clavis-overlay.is-open {
    display: flex;
    pointer-events: auto;

    justify-content: center;
    align-items: center;

    padding: 16px;
    overflow: auto;
    -webkit-overflow-scrolling: touch;
  }

  /* ===== Modal ===== */
  .clavis-modal {
    position: relative;
    width: min(1100px, 100%);
    max-height: calc(100dvh - 32px);
    overflow: auto;
    -webkit-overflow-scrolling: touch;

    padding: 50px;
    border-radius: 0;
    background: var(--rm-season-bg, #fff);
    box-shadow: none;
    box-sizing: border-box;
  }

  .clavis-close {
    position: absolute;
    top: 18px;
    right: 18px;
    width: 32px;
    height: 32px;
    border-radius: 999px;
    border: none;
    background: #ededed;
    cursor: pointer;
    font-size: 18px;
    line-height: 1;
  }

  .clavis-close:hover {
    background: #e5e5e5;
  }

  .clavis-layout {
    display: grid;
    grid-template-columns: minmax(0, 1.1fr) minmax(0, 2fr);
    column-gap: 72px;
    align-items: flex-start;
  }

  .clavis-col-title {
    padding-right: 8px;
  }

  .clavis-title {
    margin: 0;
    font-weight: 500;
    font-size: 32px;
    line-height: 1;
    color: #000;
    letter-spacing: -1px;
  }

  .clavis-form {
    margin: 0;
  }

  .clavis-field label {
    display: block;
    margin-bottom: 6px;
    font-size: 13px;
    color: #111;
    font-weight: 400;
    letter-spacing: -0.3px;
  }

  .clavis-field input,
  .clavis-message-block textarea {
    width: 100%;
    box-sizing: border-box;
    padding: 6px 0 8px;
    border: 0;
    border-bottom: 1px solid rgba(0, 0, 0, 0.45);
    background: transparent;
    font-size: 14px;
    outline: none;
    font-weight: 500;
    letter-spacing: -0.3px;
  }

  .clavis-field input::placeholder,
  .clavis-message-block textarea::placeholder {
    color: rgba(0, 0, 0, 0.35);
    font-weight: 400;
  }

  .clavis-field input:focus,
  .clavis-message-block textarea:focus {
    border-bottom-color: #000;
  }

  .clavis-message-title {
    font-size: 14px;
    margin-bottom: 6px;
    color: #111;
    font-weight: 400;
  }

  .clavis-message-block textarea {
    min-height: 140px;
    resize: vertical;
    font-weight: 500;
  }

  .clavis-checks {
    display: flex;
    flex-direction: column;
    margin-top: 6px;
  }

  .clavis-check {
    display: flex;
    gap: 5px;
    align-items: flex-start;
    font-size: 12px;
    line-height: 1.2;
    color: #111;
    font-weight: 400;
  }

  .clavis-check a {
    font-weight: 500;
    color: #000;
  }

  .clavis-checkbox {
    min-width: 14px;
    min-height: 14px;
    margin-top: 2px;
  }

  .err {
    min-height: 16px;
    font-size: 11px;
    color: var(--rm-season-accentColor, #d11);
  }

  .clavis-grid {
    display: grid;
    grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.2fr);
    column-gap: 48px;
    row-gap: 18px;
    grid-template-areas:
      'main side'
      'button side'
      'status status';
  }

  .clavis-main {
    grid-area: main;
    display: flex;
    flex-direction: column;
    gap: 18px;
  }

  .clavis-side {
    grid-area: side;
    display: flex;
    flex-direction: column;
    gap: 18px;
  }

  .clavis-submit {
    grid-area: button;
    margin-top: 24px;
    padding: 12px 32px;
    border-radius: 999px;
    border: 0;
    background: #000;
    color: #fff;
    font-weight: 500;
    font-size: 12px;
    cursor: pointer;
    justify-self: flex-start;
    letter-spacing: -0.3px;
  }

  .clavis-submit:hover {
    opacity: 0.75;
  }

  .clavis-submit[disabled] {
    opacity: 0.4;
    cursor: not-allowed;
  }

  .clavis-status {
    margin-top: 10px;
    font-size: 13px;
  }

  .clavis-hp {
    position: absolute;
    left: -9999px;
    width: 1px;
    height: 1px;
    overflow: hidden;
  }

  /* ===== Tablet + Mobile ===== */
  @media (max-width: 1024px) {
    .clavis-modal {
      padding: 24px 18px 18px;
    }

    .clavis-layout {
      grid-template-columns: 1fr;
      row-gap: 18px;
    }

    .clavis-title {
      font-size: 24px;
      line-height: 1.05;
    }

    .clavis-grid {
      grid-template-columns: 1fr;
      grid-template-areas:
        'main'
        'side'
        'button'
        'status';
      row-gap: 16px;
    }

    .clavis-submit {
      width: 100%;
      justify-self: stretch;
      text-align: center;
      margin-top: 8px;
    }

    .clavis-close {
      top: 12px;
      right: 12px;
      width: 30px;
      height: 30px;
      font-size: 16px;
    }
  }
</style>

<script>
  (function () {
    const endpoint = 'https://clavis-readymag-stripe.vercel.app/api/contact';

    function isValidHumanName(s) {
      s = (s || '').trim();
      if (!s) return false;
      if (s.length > 60) return false;
      return /^[A-Za-zÀ-ÖØ-öø-ÿ\s'-]+$/.test(s);
    }

    function escapeHtml(str) {
      return String(str || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function init() {
      const overlay = document.getElementById('clavisOverlay');
      const form = document.getElementById('clavisContactForm');
      const openBtn =
        document.getElementById('clavisOpenBtn') ||
        document.querySelector('.clavis-open-btn');
      const closeBtn =
        document.getElementById('clavisCloseBtn') ||
        (overlay ? overlay.querySelector('.clavis-close') : null);

      if (!overlay || !form || !openBtn || !closeBtn) return;

      // IMPORTANT: move overlay to <body> to avoid Readymag transforms breaking fixed
      if (overlay.parentElement !== document.body) {
        document.body.appendChild(overlay);
      }

      const statusEl = form.querySelector('.clavis-status');
      const submitBtn = form.querySelector('button[type="submit"]');
      let createdAt = Date.now();

      function setErr(name, msg) {
        const err = form.querySelector('[data-err-for="' + name + '"]');
        if (err) err.textContent = msg || '';
        const input = form.querySelector('[name="' + name + '"], #' + name);
        if (
          input &&
          (input.tagName === 'INPUT' || input.tagName === 'TEXTAREA')
        ) {
          input.classList.toggle('invalid', !!msg);
        }
      }

      function clearAll() {
        Array.prototype.slice
          .call(form.querySelectorAll('.err'))
          .forEach(function (e) {
            e.textContent = '';
          });
        Array.prototype.slice
          .call(form.querySelectorAll('input,textarea'))
          .forEach(function (el) {
            el.classList.remove('invalid');
          });
        if (statusEl) statusEl.textContent = '';
      }

      function open() {
        createdAt = Date.now();
        clearAll();
        // do NOT lock body scroll (you explicitly asked)
        overlay.classList.add('is-open');
        overlay.setAttribute('aria-hidden', 'false');
      }

      function close() {
        overlay.classList.remove('is-open');
        overlay.setAttribute('aria-hidden', 'true');
        clearAll();
      }

      openBtn.addEventListener('click', function (e) {
        e.preventDefault();
        open();
      });

      closeBtn.addEventListener('click', function () {
        close();
      });

      overlay.addEventListener('click', function (e) {
        if (e.target === overlay) close();
      });

      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape' && overlay.classList.contains('is-open'))
          close();
      });

      function validate() {
        let ok = true;

        const name = (
          form.name && form.name.value ? form.name.value : ''
        ).trim();
        const childName = (
          form.childName && form.childName.value ? form.childName.value : ''
        ).trim();
        const email = (
          form.email && form.email.value ? form.email.value : ''
        ).trim();
        const phone = (
          form.phone && form.phone.value ? form.phone.value : ''
        ).trim();
        const message = (
          form.message && form.message.value ? form.message.value : ''
        ).trim();
        const hp = (
          form.website && form.website.value ? form.website.value : ''
        ).trim();

        if (hp) return { ok: false, bot: true };
        if (Date.now() - createdAt < 1500) return { ok: false, bot: true };

        if (!name || name.length < 2 || !isValidHumanName(name)) {
          setErr('name', 'Bitte geben Sie Ihren Namen ein.');
          ok = false;
        } else setErr('name', '');

        if (
          !childName ||
          childName.length < 2 ||
          !isValidHumanName(childName)
        ) {
          setErr('childName', 'Bitte geben Sie den Namen Ihres Kindes ein.');
          ok = false;
        } else setErr('childName', '');

        if (!email) {
          setErr('email', 'Bitte geben Sie Ihre E-Mail ein.');
          ok = false;
        } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
          setErr('email', 'Bitte geben Sie eine gültige E-Mail ein.');
          ok = false;
        } else setErr('email', '');

        if (!phone) {
          setErr('phone', 'Bitte geben Sie Ihre Telefonnummer ein.');
          ok = false;
        } else if (!/^[0-9+()\s-]{6,}$/.test(phone)) {
          setErr('phone', 'Bitte geben Sie eine gültige Telefonnummer ein.');
          ok = false;
        } else setErr('phone', '');

        const privacy = form.privacy && form.privacy.checked;
        if (!privacy) {
          setErr('privacy', 'Bitte bestätigen Sie die Datenschutzerklärung.');
          ok = false;
        } else setErr('privacy', '');

        if (message.length > 2000) {
          setErr('message', 'Nachricht ist zu lang (max. 2000 Zeichen).');
          ok = false;
        } else setErr('message', '');

        return { ok };
      }

      form.addEventListener('submit', function (e) {
        e.preventDefault();
        clearAll();

        const v = validate();
        if (!v.ok || v.bot) return;

        if (submitBtn) submitBtn.disabled = true;
        if (statusEl) statusEl.textContent = 'Senden…';

        const payload = {
          name: escapeHtml((form.name.value || '').trim()),
          childName: escapeHtml((form.childName.value || '').trim()),
          email: escapeHtml((form.email.value || '').trim()),
          phone: escapeHtml((form.phone.value || '').trim()),
          message: escapeHtml((form.message.value || '').trim()),
          privacy: !!form.privacy.checked,
          page: location.href,
        };

        fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        })
          .then(function (res) {
            return res
              .json()
              .catch(function () {
                return {};
              })
              .then(function (data) {
                return { res: res, data: data };
              });
          })
          .then(function (x) {
            if (!x.res.ok) {
              if (statusEl)
                statusEl.textContent =
                  x.data.error ||
                  'Fehler beim Senden. Bitte versuchen Sie es erneut.';
              if (submitBtn) submitBtn.disabled = false;
              return;
            }

            if (statusEl)
              statusEl.textContent = 'Danke! Ihre Nachricht wurde gesendet.';
            form.reset();
            if (submitBtn) submitBtn.disabled = false;
          })
          .catch(function () {
            if (statusEl)
              statusEl.textContent =
                'Netzwerkfehler. Bitte später erneut versuchen.';
            if (submitBtn) submitBtn.disabled = false;
          });
      });

      // Ensure closed state on load (so page scroll NEVER breaks)
      overlay.classList.remove('is-open');
      overlay.setAttribute('aria-hidden', 'true');
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>
