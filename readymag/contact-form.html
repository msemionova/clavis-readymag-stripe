<p class="clavis-open-btn">KONTAKTE</p>

<div id="clavisOverlay" class="clavis-overlay clavis-hidden">
  <div class="clavis-modal">
    <button class="clavis-close" type="button" aria-label="Schließen">✕</button>
    <div class="clavis-layout">
      <div class="clavis-col clavis-col-title">
        <h2 class="clavis-title">
          Du bist interessiert?<br />Sende uns eine Nachricht
        </h2>
      </div>

      <form id="clavisContactForm" class="clavis-form" novalidate>
        <label class="clavis-hp">
          Website
          <input name="website" autocomplete="off" />
        </label>

        <div class="clavis-grid">
          <div class="clavis-main">
            <div class="clavis-field">
              <label for="name">Vor- und Nachname</label>
              <input
                id="name"
                name="name"
                type="text"
                placeholder="Vor- und Nachname"
                required
                minlength="2"
                autocomplete="name"
              />
              <div class="err" data-err-for="name"></div>
            </div>

            <div class="clavis-field">
              <label for="childName">Name Ihres Kindes</label>
              <input
                id="childName"
                name="childName"
                type="text"
                placeholder="Name Ihres Kindes"
                required
                minlength="2"
                autocomplete="name"
              />
              <div class="err" data-err-for="childName"></div>
            </div>

            <div class="clavis-field">
              <label for="email">E-mail</label>
              <input
                id="email"
                name="email"
                type="email"
                placeholder="E-Mail-Adresse"
                required
              />
              <div class="err" data-err-for="email"></div>
            </div>

            <div class="clavis-field">
              <label for="phone">Telefonnummer</label>
              <input
                id="phone"
                name="phone"
                type="tel"
                placeholder="Telefonnummer"
                required
                inputmode="tel"
                pattern="^[0-9+()\\s-]{6,}$"
              />
              <div class="err" data-err-for="phone"></div>
            </div>
          </div>

          <div class="clavis-side">
            <div class="clavis-message-block">
              <div class="clavis-message-title">
                Wie können wir Ihnen helfen?
              </div>
              <textarea
                id="message"
                name="message"
                rows="6"
                placeholder="Ihre Nachricht"
              ></textarea>
              <div class="err" data-err-for="message"></div>
            </div>

            <div class="clavis-checks">
              <label class="clavis-check">
                <input id="agb" name="agb" type="checkbox" required />
                <span>
                  Die
                  <a
                    href="https://readymag.website/u612815371/5961069/agb"
                    target="_blank"
                    rel="noopener"
                    >AGB</a
                  >
                  habe ich zur Kenntnis genommen
                </span>
              </label>
              <div class="err" data-err-for="agb"></div>

              <label class="clavis-check">
                <input id="privacy" name="privacy" type="checkbox" required />
                <span>
                  <a
                    href="https://readymag.website/u612815371/5961069/datenschutz"
                    target="_blank"
                    rel="noopener"
                    >Datenschutzerklärung</a
                  >
                  gelesen und nehme sie zur Kenntnis
                </span>
              </label>
              <div class="err" data-err-for="privacy"></div>
            </div>
          </div>

          <button class="clavis-submit" type="submit">Nachricht senden</button>

          <div class="clavis-status" aria-live="polite"></div>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
  .clavis-open-btn {
    position: relative;
    top: 14px;
    color: #000;
    font-weight: 500;
    font-size: 10px;
    cursor: pointer;
  }

  .clavis-overlay {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(0, 0, 0, 0.65);
    z-index: 9999;
    transition: opacity 0.2s ease;
    padding: 25px;
    overflow-y: auto;
  }

  .clavis-hidden {
    opacity: 0;
    pointer-events: none;
  }

  .clavis-modal {
    position: relative;
    width: 100%;
    padding: 50px;
    border-radius: 0;
    background: var(--rm-season-bg);
    box-shadow: none;
    box-sizing: border-box;
    max-height: none;
    overflow: visible;
  }

  .clavis-close {
    position: absolute;
    top: 24px;
    right: 28px;
    width: 32px;
    height: 32px;
    border-radius: 999px;
    border: none;
    background: #ededed;
    cursor: pointer;
    font-size: 18px;
    line-height: 1;
  }

  .clavis-close:hover {
    background: #e5e5e5;
  }

  .clavis-layout {
    display: grid;
    grid-template-columns: minmax(0, 1.1fr) minmax(0, 2fr);
    column-gap: 72px;
    align-items: flex-start;
  }

  .clavis-col-title {
    padding-right: 8px;
  }

  .clavis-title {
    margin: 0;
    font-weight: 500;
    font-size: 32px;
    line-height: 1.15;
    color: #000;
    letter-spacing: -1px;
  }

  .clavis-form {
    margin: 0;
  }

  .clavis-field label {
    display: block;
    margin-bottom: 6px;
    font-size: 13px;
    color: #111;
    font-weight: 400;
    letter-spacing: -0.3px;
  }

  .clavis-field input,
  .clavis-message-block textarea {
    width: 100%;
    box-sizing: border-box;
    padding: 6px 0 8px;
    border: 0;
    border-bottom: 1px solid rgba(0, 0, 0, 0.45);
    background: transparent;
    font-size: 14px;
    outline: none;
    font-weight: 500;
    letter-spacing: -0.3px;
  }

  .clavis-field input::placeholder,
  .clavis-message-block textarea::placeholder {
    color: rgba(0, 0, 0, 0.35);
    font-weight: 400;
  }

  .clavis-field input:focus,
  .clavis-message-block textarea:focus {
    border-bottom-color: #000;
  }

  .clavis-field input.invalid,
  .clavis-message-block textarea.invalid {
    border-bottom-color: var(--rm-season-accentColor);
  }

  .clavis-message-title {
    font-size: 14px;
    margin-bottom: 6px;
    color: #111;
    font-weight: 400;
  }

  .clavis-message-block textarea {
    min-height: 140px;
    resize: vertical;
    font-weight: 500;
  }

  .clavis-checks {
    display: flex;
    flex-direction: column;
    margin-top: 6px;
  }

  .clavis-check {
    display: flex;
    gap: 10px;
    align-items: flex-start;
    font-size: 12px;
    line-height: 1;
    color: #111;
    font-weight: 400;
  }

  .clavis-check input {
    margin-top: 2px;
  }

  .clavis-check a {
    font-weight: 500;
    color: #000;
  }

  .err {
    min-height: 16px;
    font-size: 11px;
    color: var(--rm-season-accentColor);
  }

  .clavis-grid {
    display: grid;
    grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.2fr);
    column-gap: 48px;
    row-gap: 18px;
    grid-template-areas:
      'main side'
      'button side'
      'status status';
  }

  .clavis-main {
    grid-area: main;
    display: flex;
    flex-direction: column;
    gap: 18px;
  }

  .clavis-side {
    grid-area: side;
    display: flex;
    flex-direction: column;
    gap: 18px;
  }

  .clavis-submit {
    grid-area: button;
    margin-top: 24px;
    padding: 12px 32px;
    border-radius: 999px;
    border: 0;
    background: #000;
    color: #fff;
    font-weight: 500;
    font-size: 12px;
    cursor: pointer;
    justify-self: flex-start;
    letter-spacing: -0.3px;
  }

  .clavis-submit:hover {
    opacity: 0.75;
  }

  .clavis-submit[disabled] {
    opacity: 0.4;
    cursor: not-allowed;
  }

  .clavis-status {
    margin-top: 18px;
    font-size: 13px;
  }

  .clavis-hp {
    position: absolute;
    left: -9999px;
    width: 1px;
    height: 1px;
    overflow: hidden;
  }

  @media (max-width: 1024px) {
    .clavis-overlay {
      padding: 32px 16px 24px;
      align-items: unset;
    }

    .clavis-modal {
      padding: 32px 28px 24px;
      max-width: 100%;
      overflow: auto;
    }

    .clavis-layout {
      grid-template-columns: 1fr;
      row-gap: 24px;
    }

    .clavis-title {
      font-size: 28px;
    }

    .clavis-grid {
      grid-template-columns: 1fr;
      grid-template-areas:
        'main'
        'side'
        'button'
        'status';
      row-gap: 20px;
    }

    .clavis-submit {
      width: 100%;
      justify-self: stretch;
      text-align: center;
      margin-top: 8px;
    }
  }
</style>

<script>
  (function initContactWidget() {
    const endpoint = 'https://clavis-readymag-stripe.vercel.app/api/contact';

    function waitForElements() {
      const overlay = document.getElementById('clavisOverlay');
      const form = document.getElementById('clavisContactForm');
      const openBtn = document.querySelector('.clavis-open-btn');

      if (!overlay || !form || !openBtn) {
        setTimeout(waitForElements, 100);
        return;
      }

      setup(overlay, form, openBtn);
    }

    function setup(overlay, form, openBtn) {
      const modal = overlay.querySelector('.clavis-modal');
      const statusEl = form.querySelector('.clavis-status');
      const submitBtn = form.querySelector('button[type="submit"]');
      let createdAt = Date.now();

      if (overlay.parentElement !== document.body) {
        document.body.appendChild(overlay);
      }

      const openModal = () => {
        createdAt = Date.now();
        clearAll();
        form.reset();
        overlay.classList.remove('clavis-hidden');
      };

      const closeModal = () => {
        overlay.classList.add('clavis-hidden');
        sessionStorage.setItem('clavisContactDismissed', '1');
        form.reset();
        clearAll();
      };

      openBtn.addEventListener('click', (e) => {
        e.preventDefault();
        openModal();
      });

      if (modal) {
        const closeBtn = modal.querySelector('.clavis-close');
        if (closeBtn) closeBtn.addEventListener('click', closeModal);
      }

      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) closeModal();
      });

      document.addEventListener('keydown', (e) => {
        if (
          e.key === 'Escape' &&
          !overlay.classList.contains('clavis-hidden')
        ) {
          closeModal();
        }
      });

      const setErr = (name, msg) => {
        const err = form.querySelector(`[data-err-for="${name}"]`);
        if (err) err.textContent = msg || '';
        const input = form.querySelector(`[name="${name}"], #${name}`);
        if (
          input &&
          (input.tagName === 'INPUT' || input.tagName === 'TEXTAREA')
        ) {
          input.classList.toggle('invalid', !!msg);
        }
      };

      const clearAll = () => {
        [...form.querySelectorAll('.err')].forEach((e) => (e.textContent = ''));
        [...form.querySelectorAll('input,textarea')].forEach((el) =>
          el.classList.remove('invalid')
        );
        if (statusEl) statusEl.textContent = '';
      };

      const validate = () => {
        let ok = true;

        const name = form.name.value.trim();
        const childName = form.childName.value.trim();
        const email = form.email.value.trim();
        const phone = form.phone.value.trim();
        const message = form.message.value.trim();
        const hp = form.website.value.trim();

        if (hp) return { ok: false, bot: true };

        if (Date.now() - createdAt < 3000) {
          return { ok: false, bot: true };
        }

        if (name.length < 2) {
          setErr('name', 'Bitte geben Sie Ihren Namen ein.');
          ok = false;
        } else setErr('name', '');

        if (childName.length < 2) {
          setErr('childName', 'Bitte geben Sie den Namen Ihres Kindes ein.');
          ok = false;
        } else setErr('childName', '');

        if (!email) {
          setErr('email', 'Bitte geben Sie Ihre E-Mail ein.');
          ok = false;
        } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
          setErr('email', 'Bitte geben Sie eine gültige E-Mail ein.');
          ok = false;
        } else setErr('email', '');

        if (!phone) {
          setErr('phone', 'Bitte geben Sie Ihre Telefonnummer ein.');
          ok = false;
        } else if (!/^[0-9+()\s-]{6,}$/.test(phone)) {
          setErr('phone', 'Bitte geben Sie eine gültige Telefonnummer ein.');
          ok = false;
        } else setErr('phone', '');

        if (!form.agb.checked) {
          setErr('agb', 'Bitte bestätigen Sie die AGB.');
          ok = false;
        } else setErr('agb', '');
        if (!form.privacy.checked) {
          setErr('privacy', 'Bitte bestätigen Sie die Datenschutzerklärung.');
          ok = false;
        } else setErr('privacy', '');

        if (message.length > 2000) {
          setErr('message', 'Nachricht ist zu lang (max. 2000 Zeichen).');
          ok = false;
        } else setErr('message', '');

        return { ok };
      };

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        clearAll();

        const v = validate();
        if (!v.ok) return;
        if (v.bot) return;

        submitBtn.disabled = true;
        if (statusEl) statusEl.textContent = 'Senden…';

        const payload = {
          name: form.name.value.trim(),
          childName: form.childName.value.trim(),
          email: form.email.value.trim(),
          phone: form.phone.value.trim(),
          message: form.message.value.trim(),
          agb: form.agb.checked,
          privacy: form.privacy.checked,
          page: location.href,
        };

        try {
          const res = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });

          const data = await res.json().catch(() => ({}));
          if (!res.ok) {
            if (statusEl) {
              statusEl.textContent =
                data?.error ||
                'Fehler beim Senden. Bitte versuchen Sie es erneut.';
            }
            submitBtn.disabled = false;
            return;
          }

          if (statusEl)
            statusEl.textContent = 'Danke! Ihre Nachricht wurde gesendet.';
          form.reset();
          submitBtn.disabled = false;
        } catch (err) {
          if (statusEl) {
            statusEl.textContent =
              'Netzwerkfehler. Bitte später erneut versuchen.';
          }
          submitBtn.disabled = false;
        }
      });

      if (!sessionStorage.getItem('clavisContactDismissed')) {
        setTimeout(() => {
          if (overlay.classList.contains('clavis-hidden')) {
            openModal();
          }
        }, 20000);
      }
    }

    waitForElements();
  })();
</script>
